<!DOCTYPE html>
<html>
<head>
  <title>Gemini CLI Web App</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    .dark-mode {
      background-color: #111;
      color: #fff;
    }
  </style>
</head>
<body>
  <main class="container">
    <nav>
      <ul>
        <li><strong>Gemini CLI Web App</strong></li>
      </ul>
      <ul>
        <li><a href="/settings.html">Settings</a></li>
        <li><a href="#" id="theme-switcher">Switch Theme</a></li>
      </ul>
    </nav>
    <h1>Gemini CLI Web App</h1>
  <form id="gemini-form">
    <label for="command">Command:</label>
    <input type="text" id="command" name="command" required list="command-history">
    <datalist id="command-history"></datalist>
    <button type="submit">Run</button>
  </form>
  <pre id="output"></pre>
  <button id="clear-output">Clear</button>

  <h2>GitHub Pull Requests</h2>
  <form id="github-form">
    <label for="owner">Owner:</label>
    <input type="text" id="owner" name="owner" required>
    <label for="repo">Repo:</label>
    <input type="text" id="repo" name="repo" required>
    <button type="submit">Get PRs</button>
  </form>
  <ul id="prs"></ul>

  <h2>Trigger GitHub Action</h2>
  <form id="github-action-form">
    <label for="action-owner">Owner:</label>
    <input type="text" id="action-owner" name="owner" required>
    <label for="action-repo">Repo:</label>
    <input type="text" id="action-repo" name="repo" required>
    <label for="workflow-id">Workflow ID:</label>
    <input type="text" id="workflow-id" name="workflow_id" required>
    <button type="submit">Run Workflow</button>
  </form>
  <p id="action-status"></p>

  <h2>List GitHub Workflows</h2>
  <form id="list-workflows-form">
    <label for="list-owner">Owner:</label>
    <input type="text" id="list-owner" name="owner" required>
    <label for="list-repo">Repo:</label>
    <input type="text" id="list-repo" name="repo" required>
    <button type="submit">List Workflows</button>
  </form>
  <ul id="workflows"></ul>

  <dialog id="diff-modal">
    <article>
      <header>
        <a href="#close" aria-label="Close" class="close"></a>
        Diff
      </header>
      <pre id="diff-output"></pre>
      <footer>
        <form id="comment-form">
          <label for="comment">Comment:</label>
          <textarea id="comment" name="comment" required></textarea>
          <button type="submit">Post Comment</button>
        </form>
      </footer>
    </article>
  </dialog>

  <script>
    const output = document.getElementById('output');
    const socket = new WebSocket(`ws://${window.location.host}`);
    const commandHistoryDatalist = document.getElementById('command-history');

    socket.onmessage = (event) => {
      const { type, data, code } = JSON.parse(event.data);
      if (type === 'stdout' || type === 'stderr') {
        output.textContent += data;
      } else if (type === 'close') {
        output.textContent += `\nProcess exited with code ${code}`;
        hljs.highlightElement(output);
      } else if (type === 'history') {
        data.forEach(command => {
          const option = document.createElement('option');
          option.value = command;
          commandHistoryDatalist.appendChild(option);
        });
      }
    };

    document.getElementById('gemini-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const command = document.getElementById('command').value;
      output.textContent = '';
      socket.send(JSON.stringify({ command }));
    });

    document.getElementById('clear-output').addEventListener('click', () => {
      output.textContent = '';
    });

    document.getElementById('theme-switcher').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });

    document.getElementById('github-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const owner = document.getElementById('owner').value;
      const repo = document.getElementById('repo').value;
      const prsList = document.getElementById('prs');
      prsList.innerHTML = 'Loading...';

      const response = await fetch(`/github/prs?owner=${owner}&repo=${repo}`);
      const prs = await response.json();

      prsList.innerHTML = '';
      prs.forEach(pr => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${pr.html_url}">${pr.title}</a> <button class="view-diff" data-pr="${pr.number}">View Diff</button>`;
        prsList.appendChild(li);
      });
    });

    let currentPrNumber;

    document.getElementById('prs').addEventListener('click', async (e) => {
      if (e.target.classList.contains('view-diff')) {
        const owner = document.getElementById('owner').value;
        const repo = document.getElementById('repo').value;
        currentPrNumber = e.target.dataset.pr;
        const diffOutput = document.getElementById('diff-output');
        diffOutput.textContent = 'Loading...';
        document.getElementById('diff-modal').showModal();

        const response = await fetch(`/github/prs/${currentPrNumber}/diff?owner=${owner}&repo=${repo}`);
        const diff = await response.text();
        diffOutput.textContent = diff;
      }
    });

    document.getElementById('comment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const owner = document.getElementById('owner').value;
      const repo = document.getElementById('repo').value;
      const comment = document.getElementById('comment').value;

      const response = await fetch(`/github/prs/${currentPrNumber}/comments`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ owner, repo, comment }),
      });

      if (response.ok) {
        document.getElementById('diff-modal').close();
      }
    });

    document.getElementById('github-action-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const owner = document.getElementById('action-owner').value;
      const repo = document.getElementById('action-repo').value;
      const workflow_id = document.getElementById('workflow-id').value;
      const status = document.getElementById('action-status');
      status.textContent = 'Triggering...';

      const response = await fetch('/github/actions/run', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ owner, repo, workflow_id }),
      });
      const text = await response.text();
      status.textContent = text;
    });

    document.getElementById('list-workflows-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const owner = document.getElementById('list-owner').value;
      const repo = document.getElementById('list-repo').value;
      const workflowsList = document.getElementById('workflows');
      workflowsList.innerHTML = 'Loading...';

      const response = await fetch(`/github/actions/workflows?owner=${owner}&repo=${repo}`);
      const data = await response.json();

      workflowsList.innerHTML = '';
      data.workflows.forEach(workflow => {
        const li = document.createElement('li');
        li.textContent = `${workflow.name} (ID: ${workflow.id})`;
        workflowsList.appendChild(li);
      });
    });
  </script>
</body>
</html>
